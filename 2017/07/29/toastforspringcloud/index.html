<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> a toast of microservice in spring cloud · FuXi's Daily</title><meta name="description" content="a toast of microservice in spring cloud - John Doe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="FuXi's Daily"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/fuxi1993" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">a toast of microservice in spring cloud</h1><div class="post-info">Jul 29, 2017</div><div class="post-content"><h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p><img src="/2017/07/29/toastforspringcloud/1.jpg" alt="M1艾斯拉姆斯主战坦克"><br>美国的M1型艾斯拉姆斯主战坦克常年位居各大主战坦克排行榜的首位，而且在实战中也表现出惊人的均衡性能，可以说号称蓝星最强主战坦克，M1极其改进型M1A1, M1A2等在开发到服役的这几十年里能够表现出如此强大的能力，原因之一是采用了模块化的设计和实现，这样能够保证坦克能够进行强有力的持续更新改进。<br><br>微服务的出现同样也是这样的目的，微服务能够保证大型，复杂的应用程序实现持续的发布和部署。</p>
<h3 id="A-toast-of-spring-cloud-implemented-microservice"><a href="#A-toast-of-spring-cloud-implemented-microservice" class="headerlink" title="A toast of spring cloud implemented microservice"></a>A toast of spring cloud implemented microservice</h3><p>我使用了 <a href="https://github.com/sqshq/PiggyMetrics" target="_blank" rel="noopener">PiggyMetrics</a> 这个开源项目来一步步分析基于spring cloud, spring boot, docker的微服务应用程序的设计和实现的过程，其中着重在代码的层面，因为架构的东西作者的README已经写的很好了。<br><img src="/2017/07/29/toastforspringcloud/2.png" alt="PiggyMetrics架构图"></p>
<h3 id="关于config-service"><a href="#关于config-service" class="headerlink" title="关于config service"></a>关于config service</h3><blockquote>
<p>Spring Cloud Config provides server and client-side support for externalized configuration in a distributed system. With the Config Server you have a central place to manage external properties for applications across all environments. </p>
</blockquote>
<p>在piggyMetrics中，config service的application.yml配置如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      server:</span></span><br><span class="line"><span class="attr">        native:</span></span><br><span class="line"><span class="attr">          search-locations:</span> <span class="attr">classpath:/shared</span></span><br><span class="line"><span class="attr">  profiles:</span></span><br><span class="line"><span class="attr">     active:</span> <span class="string">native</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8888</span></span><br><span class="line"></span><br><span class="line"><span class="attr">security:</span></span><br><span class="line"><span class="attr">  user:</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">$&#123;CONFIG_SERVICE_PASSWORD&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>有srping.profile.active: native知是一种file system backend的方式，搜索的位置是classpath:/shared，即在当前文件夹的shared子文件夹下。比如说当notificaiton service需要config时，config service就将application.yml和shared/notification-service.yml响应过去。<br><br>在client端的响应就是通过bootstrap.yml的配置就行获取相应的资源,如在auth service模块的bootstrap.yml如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">auth-service</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      uri:</span> <span class="attr">http://config:8888</span></span><br><span class="line"><span class="attr">      fail-fast:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      password:</span> <span class="string">$&#123;CONFIG_SERVICE_PASSWORD&#125;</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">user</span></span><br></pre></td></tr></table></figure></p>
<p>spring.cloud.config.url表示了config服务的位置，以及用户名，密码等信息，这样autu service就能简单的获取自己的配置信息。</p>
<p><br>引用：<br></p>
<ul>
<li><a href="http://blog.csdn.net/liaokailin/article/details/51307215" target="_blank" rel="noopener">spring cloud config入门</a></li>
<li><a href="http://cloud.spring.io/spring-cloud-config/spring-cloud-config.html#_client_side_usage" target="_blank" rel="noopener">spring cloud config</a></li>
</ul>
<h3 id="关于auth-service"><a href="#关于auth-service" class="headerlink" title="关于auth service"></a>关于auth service</h3><p>在这个系统中，autu service用来进行用户认证，系统中服务与服务之间的认证。因为UI层只是用password认证，所以系统使用password credentials来进行认证。</p>
<p>From the client side, everything works exactly the same as with traditional session-based authorization. You can retrieve Principal object from request, check user’s roles and other stuff with expression-based access control and @PreAuthorize annotation.</p>
<p>Each client in PiggyMetrics (account-service, statistics-service, notification-service and browser) has a scope: server for backend services, and ui - for the browser. So we can also protect controllers from external access, for example，在account service中controller/AccountController.java中:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize</span>(<span class="string">"#oauth2.hasScope('server') or #name.equals('demo')"</span>)</span><br><span class="line"><span class="meta">@RequestMapping</span>(path = <span class="string">"/&#123;name&#125;"</span>, method = RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Account <span class="title">getAccountByName</span><span class="params">(@PathVariable String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> accountService.findByName(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个auth service还不是弄的很清楚，也许需要等看看API Gateway再来看这个设计和实现。<br><br>引用：</p>
<ul>
<li><a href="http://cloud.spring.io/spring-cloud-security/spring-cloud-security.html" target="_blank" rel="noopener">spring cloud security</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html" target="_blank" rel="noopener">理解OAuth 2.0</a></li>
</ul>
<h3 id="关于API-Gateway"><a href="#关于API-Gateway" class="headerlink" title="关于API Gateway"></a>关于API Gateway</h3><p><img src="/2017/07/29/toastforspringcloud/3.png" alt=""><center>Functional services</center></p>
<p><br> 如图所示，系统有三个主要服务，因为业务的扩张，这些水平服务可能会快速增长，hundreds of services might be involved in rendering of one complex webpage.<br><br> In theory, a client could make requests to each of the microservices directly. But obviously, there are challenges and limitations with this option, like necessity to know all endpoints addresses, perform http request for each peace of information separately, merge the result on a client side. Another problem is non web-friendly protocols which might be used on the backend.</p>
<p>Usually a much better approach is to use API Gateway. It is a single entry point into the system, used to handle requests by routing them to the appropriate backend service or by invoking multiple backend services and aggregating the results. Also, it can be used for authentication, insights, stress and canary testing, service migration, static response handling, active traffic management.</p>
<p>Netflix opensourced such an edge service, and now with Spring Cloud we can enable it with one @EnableZuulProxy annotation. In this project, I use Zuul to store static content (ui application) and to route requests to appropriate microservices. Here’s a simple prefix-based routing configuration for Notification service:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    notification-service:</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/notifications/**</span></span><br><span class="line"><span class="attr">        serviceId:</span> <span class="string">notification-service</span></span><br><span class="line"><span class="attr">        stripPrefix:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>这表示所有的以/notifications开头的请求都会被routes到notification service，这些没有硬编码的地址。 Zuul 使用服务发现机制来定位notification服务，以及 Circuit Breaker and Load Balancer。<br>在Gateway服务中，应用程序使用了上面的注解：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(GatewayApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同时在config service中对应的gateway.yml文件，也就是gateway服务的配置项中可以看到其对不同服务的路由配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line"><span class="attr">  command:</span></span><br><span class="line"><span class="attr">    default:</span></span><br><span class="line"><span class="attr">      execution:</span></span><br><span class="line"><span class="attr">        isolation:</span></span><br><span class="line"><span class="attr">          thread:</span></span><br><span class="line"><span class="attr">            timeoutInMilliseconds:</span> <span class="number">20000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line"><span class="attr">  ReadTimeout:</span> <span class="number">20000</span></span><br><span class="line"><span class="attr">  ConnectTimeout:</span> <span class="number">20000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  ignoredServices:</span> <span class="string">'*'</span></span><br><span class="line"><span class="attr">  host:</span></span><br><span class="line"><span class="attr">    connect-timeout-millis:</span> <span class="number">20000</span></span><br><span class="line"><span class="attr">    socket-timeout-millis:</span> <span class="number">20000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    auth-service:</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/uaa/**</span></span><br><span class="line"><span class="attr">        url:</span> <span class="attr">http://auth-service:5000</span></span><br><span class="line"><span class="attr">        stripPrefix:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">        sensitiveHeaders:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    account-service:</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/accounts/**</span></span><br><span class="line"><span class="attr">        serviceId:</span> <span class="string">account-service</span></span><br><span class="line"><span class="attr">        stripPrefix:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">        sensitiveHeaders:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    statistics-service:</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/statistics/**</span></span><br><span class="line"><span class="attr">        serviceId:</span> <span class="string">statistics-service</span></span><br><span class="line"><span class="attr">        stripPrefix:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">        sensitiveHeaders:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    notification-service:</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/notifications/**</span></span><br><span class="line"><span class="attr">        serviceId:</span> <span class="string">notification-service</span></span><br><span class="line"><span class="attr">        stripPrefix:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">        sensitiveHeaders:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">4000</span></span><br></pre></td></tr></table></figure></p>
<h4 id="Service-Discovery"><a href="#Service-Discovery" class="headerlink" title="Service Discovery"></a>Service Discovery</h4><p>Another commonly known architecture pattern is Service discovery. It allows automatic detection of network locations for service instances, which could have dynamically assigned addresses because of auto-scaling, failures and upgrades.</p>
<p>The key part of Service discovery is Registry. I use Netflix Eureka in this project. Eureka is a good example of the client-side discovery pattern, when client is responsible for determining locations of available service instances (using Registry server) and load balancing requests across them.</p>
<p>With Spring Boot, you can easily build Eureka Registry with spring-cloud-starter-eureka-server dependency, @EnableEurekaServer annotation and simple configuration properties.</p>
<p>Client support enabled with @EnableDiscoveryClient annotation an bootstrap.yml with application name:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">notification-service</span></span><br></pre></td></tr></table></figure>
<p>Now, on application startup, it will register with Eureka Server and provide meta-data, such as host and port, health indicator URL, home page etc. Eureka receives heartbeat messages from each instance belonging to a service. If the heartbeat fails over a configurable timetable, the instance will be removed from the registry.</p>
<p>Also, Eureka provides a simple interface, where you can track running services and number of available instances: <a href="http://localhost:8761" target="_blank" rel="noopener">http://localhost:8761</a></p>
<p>在这个系统中，registry服务的代码和配置体现了这一项，在RegistryApplication.java中可以看到其作为服务发现的注解：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistryApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(RegistryApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>####Load balancer, Circuit breaker and Http client</p>
<p>Netflix OSS provides another great set of tools.</p>
<h5 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h5><p>Ribbon is a client side load balancer which gives you a lot of control over the behaviour of HTTP and TCP clients. Compared to a traditional load balancer, there is no need in additional hop for every over-the-wire invocation - you can contact desired service directly.</p>
<p>Out of the box, it natively integrates with Spring Cloud and Service Discovery. Eureka Client provides a dynamic list of available servers so Ribbon could balance between them.</p>
<h5 id="Hystrix"><a href="#Hystrix" class="headerlink" title="Hystrix"></a>Hystrix</h5><p>Hystrix is the implementation of Circuit Breaker pattern, which gives a control over latency and failure from dependencies accessed over the network. The main idea is to stop cascading failures in a distributed environment with a large number of microservices. That helps to fail fast and recover as soon as possible - important aspects of fault-tolerant systems that self-heal.</p>
<p>Besides circuit breaker control, with Hystrix you can add a fallback method that will be called to obtain a default value in case the main command fails.</p>
<p>Moreover, Hystrix generates metrics on execution outcomes and latency for each command, that we can use to monitor system behavior.</p>
<h5 id="Feign"><a href="#Feign" class="headerlink" title="Feign"></a>Feign</h5><p>Feign is a declarative Http client, which seamlessly integrates with Ribbon and Hystrix. Actually, with one spring-cloud-starter-feign dependency and @EnableFeignClients annotation you have a full set of Load balancer, Circuit breaker and Http client with sensible ready-to-go default configuration.</p>
<p>Here is an example from Account Service:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"statistics-service"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StatisticsServiceClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(method = RequestMethod.PUT, value = <span class="string">"/statistics/&#123;accountName&#125;"</span>, consumes = MediaType.APPLICATION_JSON_UTF8_VALUE)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateStatistics</span><span class="params">(@PathVariable(<span class="string">"accountName"</span>)</span> String accountName, Account account)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>Everything you need is just an interface</li>
<li>You can share @RequestMapping part between Spring MVC controller and Feign methods</li>
<li>Above example specifies just desired service id - statistics-service, thanks to autodiscovery through Eureka (but obviously you can access any resource with a specific url)</li>
</ul>
<h3 id="Monitor-service"><a href="#Monitor-service" class="headerlink" title="Monitor service"></a>Monitor service</h3><p>略过</p>
<h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h3><p>下面这篇blog是一片非常好的关于spring cloud 与kubernetes之间选择的博客，推荐给大家看看：<a href="https://developers.redhat.com/blog/2016/12/09/spring-cloud-for-microservices-compared-to-kubernetes/" target="_blank" rel="noopener"><em>spring cloud for microservices compared to kubernetes</em></a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/08/04/cc-uploader-in-CloudFoundry/" class="prev">PREV</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://yoursite.com">John Doe</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>