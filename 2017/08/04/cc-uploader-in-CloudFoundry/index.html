<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> cc-uploader in CloudFoundry · FuXi's Daily</title><meta name="description" content="cc-uploader in CloudFoundry - John Doe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="FuXi's Daily"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/fuxi1993" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">cc-uploader in CloudFoundry</h1><div class="post-info">Aug 4, 2017</div><div class="post-content"><p>The CC-Bridge translates staging and running requests into Tasks and Long Running Processes (LRPs), then submits these to the Bulletin Board System (BBS) through an API over HTTP.</p>
<h3 id="Routes-of-cc-uploader"><a href="#Routes-of-cc-uploader" class="headerlink" title="Routes of cc-uploader"></a>Routes of cc-uploader</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    UploadDropletRoute        = <span class="string">"UploadDroplet"</span></span><br><span class="line">    UploadBuildArtifactsRoute = <span class="string">"UploadBuildArtifacts"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Routes = rata.Routes&#123;</span><br><span class="line">    &#123;Name: UploadDropletRoute, Method: <span class="string">"POST"</span>, Path: <span class="string">"/v1/droplet/:guid"</span>&#125;,</span><br><span class="line">    &#123;Name: UploadBuildArtifactsRoute, Method: <span class="string">"POST"</span>, Path: <span class="string">"/v1/build_artifacts/:app_guid"</span>&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过routes的定义可知，cc会将指定的droplet文件，或者artifacts文件上传到cc的blobstore.</p>
<h3 id="Handlers-of-routes"><a href="#Handlers-of-routes" class="headerlink" title="Handlers of routes"></a>Handlers of routes</h3><p>通过观察handlers/handlers.go文件可以每个route对应的handler的定义和实现<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(uploader ccclient.Uploader, poller ccclient.Poller, logger lager.Logger)</span> <span class="params">(http.Handler, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> rata.NewRouter(ccuploader.Routes, rata.Handlers&#123;</span><br><span class="line">        ccuploader.UploadDropletRoute:        upload_droplet.New(uploader, poller, logger),</span><br><span class="line">        ccuploader.UploadBuildArtifactsRoute: upload_build_artifacts.New(uploader, logger),</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="1-分析upload-droplet-New"><a href="#1-分析upload-droplet-New" class="headerlink" title="1.分析upload_droplet.New()"></a>1.分析upload_droplet.New()</h4><p>进入handlers/upload_droplet.go文件：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(uploader ccclient.Uploader, poller ccclient.Poller, logger lager.Logger)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;dropletUploader&#123;</span><br><span class="line">        uploader: uploader,</span><br><span class="line">        poller:   poller,</span><br><span class="line">        logger:   logger,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> dropletUploader <span class="keyword">struct</span> &#123;</span><br><span class="line">    uploader ccclient.Uploader</span><br><span class="line">    poller   ccclient.Poller</span><br><span class="line">    logger   lager.Logger</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *dropletUploader)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    logger := h.logger.Session(<span class="string">"droplet.upload"</span>)</span><br><span class="line"></span><br><span class="line">    logger.Info(<span class="string">"extracting-droplet-upload-uri-key"</span>)</span><br><span class="line">    uploadUriParameter := r.URL.Query().Get(cc_messages.CcDropletUploadUriKey)</span><br><span class="line">    <span class="keyword">if</span> uploadUriParameter == <span class="string">""</span> &#123;</span><br><span class="line">        logger.Error(<span class="string">"failed-extracting-droplet-upload-uri-key"</span>, MissingCCDropletUploadUriKeyError)</span><br><span class="line">        w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">        w.Write([]<span class="keyword">byte</span>(MissingCCDropletUploadUriKeyError.Error()))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    logger.Info(<span class="string">"succeeded-extracting-droplet-upload-uri-key"</span>)</span><br><span class="line"></span><br><span class="line">    logger.Info(<span class="string">"parsing-upload-uri-parameter"</span>)</span><br><span class="line">    uploadUrl, err := url.Parse(uploadUriParameter)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        logger.Error(<span class="string">"failed-parsing-upload-uri-parameter"</span>, err)</span><br><span class="line">        w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">        w.Write([]<span class="keyword">byte</span>(err.Error()))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    logger.Info(<span class="string">"succeeded-parsing-upload-uri-parameter"</span>)</span><br><span class="line"></span><br><span class="line">    timeout := <span class="number">5</span> * time.Minute</span><br><span class="line">    timeoutParameter := r.URL.Query().Get(cc_messages.CcTimeoutKey)</span><br><span class="line">    <span class="keyword">if</span> timeoutParameter != <span class="string">""</span> &#123;</span><br><span class="line">        t, err := strconv.Atoi(timeoutParameter)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            logger.Error(<span class="string">"failed-converting-timeout-parameter"</span>, err)</span><br><span class="line">            w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">            w.Write([]<span class="keyword">byte</span>(err.Error()))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        timeout = time.Duration(t) * time.Second</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    query := uploadUrl.Query()</span><br><span class="line">    query.Set(<span class="string">"async"</span>, <span class="string">"true"</span>)</span><br><span class="line">    uploadUrl.RawQuery = query.Encode()</span><br><span class="line"></span><br><span class="line">    cancelChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">    <span class="keyword">var</span> writerClosed &lt;-<span class="keyword">chan</span> <span class="keyword">bool</span></span><br><span class="line">    closeNotifier, ok := w.(http.CloseNotifier)</span><br><span class="line">    <span class="keyword">if</span> ok &#123;</span><br><span class="line">        writerClosed = closeNotifier.CloseNotify()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        timer := time.NewTimer(timeout)</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-writerClosed:</span><br><span class="line">            <span class="built_in">close</span>(cancelChan)</span><br><span class="line">        <span class="keyword">case</span> &lt;-timer.C:</span><br><span class="line">            <span class="built_in">close</span>(cancelChan)</span><br><span class="line">        <span class="keyword">case</span> &lt;-done:</span><br><span class="line">        &#125;</span><br><span class="line">        timer.Stop()</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">defer</span> <span class="built_in">close</span>(done)</span><br><span class="line"></span><br><span class="line">    logger = logger.WithData(lager.Data&#123;<span class="string">"upload-url"</span>: uploadUrl, <span class="string">"content-length"</span>: r.ContentLength&#125;)</span><br><span class="line">    logger.Info(<span class="string">"uploading-droplet"</span>)</span><br><span class="line">    uploadStart := time.Now()</span><br><span class="line">    uploadResponse, err := h.uploader.Upload(uploadUrl, <span class="string">"droplet.tgz"</span>, r, cancelChan)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        logger.Error(<span class="string">"failed-uploading-droplet"</span>, err)</span><br><span class="line">        <span class="keyword">if</span> uploadResponse == <span class="literal">nil</span> &#123;</span><br><span class="line">            w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            w.WriteHeader(uploadResponse.StatusCode)</span><br><span class="line">        &#125;</span><br><span class="line">        w.Write([]<span class="keyword">byte</span>(err.Error()))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    uploadEnd := time.Now()</span><br><span class="line">    logger.Info(<span class="string">"succeeded-uploading-droplet"</span>, lager.Data&#123;</span><br><span class="line">        <span class="string">"upload-duration"</span>: uploadEnd.Sub(uploadStart).String(),</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    logger.Info(<span class="string">"polling-cc-background-upload"</span>)</span><br><span class="line">    err = h.poller.Poll(uploadUrl, uploadResponse, cancelChan)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        logger.Error(<span class="string">"failed-polling-cc-background-upload"</span>, err)</span><br><span class="line">        w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">        w.Write([]<span class="keyword">byte</span>(err.Error()))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    pollEnd := time.Now()</span><br><span class="line">    logger.Info(<span class="string">"succeeded-polling-cc-background-upload"</span>, lager.Data&#123;</span><br><span class="line">        <span class="string">"poll-duration"</span>: pollEnd.Sub(uploadEnd).String(),</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    w.WriteHeader(http.StatusCreated)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上面代码所示，dropletuploader通过serveHTTP方法来处理请求：</p>
<ul>
<li>调用req.URL.Query()获取querystring parameters. <a href="https://stackoverflow.com/questions/15407719/in-gos-http-package-how-do-i-get-the-query-string-on-a-post-request" target="_blank" rel="noopener">Stackoverflow</a></li>
<li>调用RUL.Parse()来解析出uploadURL<a href="https://gobyexample.com/url-parsing" target="_blank" rel="noopener">URL parsing example</a></li>
<li>调用uploadUrl.Query()来获取uploadUrl的查询字段，并将async设为true,然后写入其中</li>
<li>然后新建一个超时器，time.NewTimer(), 同时获取w.(http.CloseNotifier).CloseNotify(), 意思是如果response写入关闭，或者超过五分钟，则取消任务可关闭选项。<a href="https://gist.github.com/cee-dub/883789dc11c82ae5d05f" target="_blank" rel="noopener">Simple Golang SSE example using CloseNotifier</a>;<a href="https://gobyexample.com/timers" target="_blank" rel="noopener">go by exampler</a></li>
<li>然后调用h.uploader.Upload()方法来上传droplet.tgz文件，注意这里面有一个cancelChan参数</li>
<li>调用h.poller.Poll(uploadUrl, uploadResponse, cancelChan)来确认上传的droplet成功。</li>
</ul>
<h4 id="2-分析upload-build-artifacts-New-uploader-logger"><a href="#2-分析upload-build-artifacts-New-uploader-logger" class="headerlink" title="2.分析upload_build_artifacts.New(uploader, logger)"></a>2.分析upload_build_artifacts.New(uploader, logger)</h4><p>进入handlers/upload_build_artifacts.go文件可见这个router的handler处理方法：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(uploader ccclient.Uploader, logger lager.Logger)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;buildArtifactUploader&#123;</span><br><span class="line">        uploader: uploader,</span><br><span class="line">        logger:   logger,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> buildArtifactUploader <span class="keyword">struct</span> &#123;</span><br><span class="line">    uploader ccclient.Uploader</span><br><span class="line">    logger   lager.Logger</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *buildArtifactUploader)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    requestLogger := h.logger.Session(<span class="string">"build-artifacts.upload"</span>)</span><br><span class="line"></span><br><span class="line">    uploadUriParameter := r.URL.Query().Get(cc_messages.CcBuildArtifactsUploadUriKey)</span><br><span class="line">    <span class="keyword">if</span> uploadUriParameter == <span class="string">""</span> &#123;</span><br><span class="line">        requestLogger.Error(<span class="string">"failed"</span>, MissingCCBuildArtifactsUploadUriKeyError)</span><br><span class="line">        w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">        w.Write([]<span class="keyword">byte</span>(MissingCCBuildArtifactsUploadUriKeyError.Error()))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uploadUrl, err := url.Parse(uploadUriParameter)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        requestLogger.Error(<span class="string">"failed: Invalid upload uri"</span>, err)</span><br><span class="line">        w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">        w.Write([]<span class="keyword">byte</span>(err.Error()))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    timeout := <span class="number">5</span> * time.Minute</span><br><span class="line">    timeoutParameter := r.URL.Query().Get(cc_messages.CcTimeoutKey)</span><br><span class="line">    <span class="keyword">if</span> timeoutParameter != <span class="string">""</span> &#123;</span><br><span class="line">        t, err := strconv.Atoi(timeoutParameter)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            requestLogger.Error(<span class="string">"failed: Invalid timeout"</span>, err)</span><br><span class="line">            w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">            w.Write([]<span class="keyword">byte</span>(err.Error()))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        timeout = time.Duration(t) * time.Second</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    requestLogger.Info(<span class="string">"start"</span>, lager.Data&#123;</span><br><span class="line">        <span class="string">"upload-url"</span>:     uploadUrl,</span><br><span class="line">        <span class="string">"content-length"</span>: r.ContentLength,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    cancelChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">    <span class="keyword">var</span> writerClosed &lt;-<span class="keyword">chan</span> <span class="keyword">bool</span></span><br><span class="line">    closeNotifier, ok := w.(http.CloseNotifier)</span><br><span class="line">    <span class="keyword">if</span> ok &#123;</span><br><span class="line">        writerClosed = closeNotifier.CloseNotify()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        timer := time.NewTimer(timeout)</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-writerClosed:</span><br><span class="line">            <span class="built_in">close</span>(cancelChan)</span><br><span class="line">        <span class="keyword">case</span> &lt;-timer.C:</span><br><span class="line">            <span class="built_in">close</span>(cancelChan)</span><br><span class="line">        <span class="keyword">case</span> &lt;-done:</span><br><span class="line">        &#125;</span><br><span class="line">        timer.Stop()</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    uploadResponse, err := h.uploader.Upload(uploadUrl, <span class="string">"buildpack_cache.tgz"</span>, r, cancelChan)</span><br><span class="line">    <span class="built_in">close</span>(done)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        requestLogger.Error(<span class="string">"failed"</span>, err)</span><br><span class="line">        <span class="keyword">if</span> uploadResponse == <span class="literal">nil</span> &#123;</span><br><span class="line">            w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            w.WriteHeader(uploadResponse.StatusCode)</span><br><span class="line">        &#125;</span><br><span class="line">        w.Write([]<span class="keyword">byte</span>(err.Error()))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    w.WriteHeader(http.StatusOK)</span><br><span class="line">    requestLogger.Info(<span class="string">"success"</span>, lager.Data&#123;</span><br><span class="line">        <span class="string">"upload-url"</span>:     uploadUrl,</span><br><span class="line">        <span class="string">"content-length"</span>: r.ContentLength,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可见差不多，只不过filename变成buildpack_cache.tgz。</p>
<h4 id="uploader-Upload"><a href="#uploader-Upload" class="headerlink" title="uploader.Upload()"></a>uploader.Upload()</h4><p>在这个方法中：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *uploader)</span> <span class="title">Upload</span><span class="params">(uploadURL *url.URL, filename <span class="keyword">string</span>, r *http.Request, cancelChan &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="params">(*http.Response, error)</span></span> &#123;</span><br><span class="line">    uploadReq, err := newMultipartRequestFromReader(r.ContentLength, r.Body, filename)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先调用了这个方法：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newMultipartRequestFromReader</span><span class="params">(contentLength <span class="keyword">int64</span>, body io.Reader, fileName <span class="keyword">string</span>)</span> <span class="params">(*http.Request, error)</span></span> &#123;</span><br><span class="line">    pipeReader, pipeWriter := io.Pipe()</span><br><span class="line"></span><br><span class="line">    multipartLength, multipartBoundary, err := computeMultipartFormLength(fileName)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    multipartWriter := multipart.NewWriter(pipeWriter)</span><br><span class="line">    multipartWriter.SetBoundary(multipartBoundary)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> err error</span><br><span class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            pipeWriter.CloseWithError(err)</span><br><span class="line">        &#125;()</span><br><span class="line"></span><br><span class="line">        filePartWriter, err := multipartWriter.CreateFormFile(FormField, fileName)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _, err = io.Copy(filePartWriter, body)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        err = multipartWriter.Close()</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    uploadReq, err := http.NewRequest(<span class="string">"POST"</span>, <span class="string">""</span>, pipeReader)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uploadReq.Header.Set(<span class="string">"Content-Type"</span>, multipartWriter.FormDataContentType())</span><br><span class="line">    uploadReq.ContentLength = contentLength + multipartLength</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> uploadReq, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//computes the length of the multi-part form request, minus the content of the form itself</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">computeMultipartFormLength</span><span class="params">(fileName <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">int64</span>, <span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">    multipartBuffer := &amp;bytes.Buffer&#123;&#125;</span><br><span class="line">    multipartWriter := multipart.NewWriter(multipartBuffer)</span><br><span class="line">    _, err := multipartWriter.CreateFormFile(FormField, fileName)</span><br><span class="line">    multipartWriter.Close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">int64</span>(multipartBuffer.Len()), multipartWriter.Boundary(), err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过这个方法生成了制定的request:</p>
<ul>
<li>获取文件的长度和边界boundary; 其中createFromFile的意义是：CreateFormFile is a convenience wrapper around CreatePart. It creates a new form-data header with the provided field name and file name.</li>
<li>构建一个multipart Writer: multipart.NewWriter(pipeWriter)</li>
<li>为这个writer设置boundary,以及导入body数据内容</li>
<li>调用http.NewRequest()生成了制定的request;<a href="http://www.jianshu.com/p/aa207155ca7d" target="_blank" rel="noopener">io.Pipe()问题</a></li>
</ul>
<p>再来看生成的request如何处理：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *uploader)</span> <span class="title">Upload</span><span class="params">(uploadURL *url.URL, filename <span class="keyword">string</span>, r *http.Request, cancelChan &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="params">(*http.Response, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> r.ContentLength &lt;= <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;http.Response&#123;StatusCode: http.StatusLengthRequired&#125;, fmt.Errorf(<span class="string">"Missing Content Length"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> r.Body.Close()</span><br><span class="line"></span><br><span class="line">    uploadReq, err := newMultipartRequestFromReader(r.ContentLength, r.Body, filename)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uploadReq.Header.Set(contentMD5Header, r.Header.Get(contentMD5Header))</span><br><span class="line">    uploadReq.URL = uploadURL</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> rsp *http.Response</span><br><span class="line">    <span class="keyword">var</span> uploadErr error</span><br><span class="line">    <span class="keyword">for</span> attempt := <span class="number">0</span>; attempt &lt; MAX_UPLOAD_RETRIES; attempt++ &#123;</span><br><span class="line">        logger := u.logger.WithData(lager.Data&#123;<span class="string">"attempt-number"</span>: attempt&#125;)</span><br><span class="line">        logger.Info(<span class="string">"uploading"</span>)</span><br><span class="line">        rsp, uploadErr = u.do(uploadReq, cancelChan)</span><br><span class="line">        <span class="keyword">if</span> uploadErr == <span class="literal">nil</span> &#123;</span><br><span class="line">            logger.Info(<span class="string">"succeeded-uploading"</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        logger.Error(<span class="string">"failed-uploading"</span>, err)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// not a connect (dial) error</span></span><br><span class="line">        <span class="keyword">var</span> nestedErr error = uploadErr</span><br><span class="line">        <span class="keyword">if</span> urlErr, ok := nestedErr.(*url.Error); ok &#123;</span><br><span class="line">            nestedErr = urlErr.Err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> netErr, ok := nestedErr.(*net.OpError); !ok || netErr.Op != <span class="string">"dial"</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rsp, uploadErr</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *uploader)</span> <span class="title">do</span><span class="params">(req *http.Request, cancelChan &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="params">(*http.Response, error)</span></span> &#123;</span><br><span class="line">    completion := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">    <span class="keyword">defer</span> <span class="built_in">close</span>(completion)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-cancelChan:</span><br><span class="line">            <span class="keyword">if</span> canceller, ok := u.client.Transport.(requestCanceller); ok &#123;</span><br><span class="line">                canceller.CancelRequest(req)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                u.logger.Error(<span class="string">"Invalid transport, does not support CancelRequest"</span>, <span class="literal">nil</span>, lager.Data&#123;<span class="string">"transport"</span>: u.client.Transport&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> &lt;-completion:</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    rsp, err := u.client.Do(req)</span><br><span class="line"></span><br><span class="line">    req.Body.Close()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> rsp.StatusCode &#123;</span><br><span class="line">    <span class="keyword">case</span> http.StatusOK, http.StatusCreated:</span><br><span class="line">        <span class="keyword">return</span> rsp, <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    respBody, _ := ioutil.ReadAll(rsp.Body)</span><br><span class="line">    rsp.Body.Close()</span><br><span class="line">    <span class="keyword">return</span> rsp, fmt.Errorf(<span class="string">"status code: %d\n%s"</span>, rsp.StatusCode, <span class="keyword">string</span>(respBody))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过为request生成header内容，设置url, 然后提交给u.Client.do()执行。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/08/17/ipvsOnK8s/" class="prev">PREV</a><a href="/2017/07/29/toastforspringcloud/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://yoursite.com">John Doe</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>